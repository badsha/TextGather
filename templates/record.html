{% extends "base.html" %}

{% block title %}Record Content - VoiceScript Collector{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Script Selection Interface -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Select a Recording Script</h1>
        <p class="text-gray-600 mb-6">Choose from available scripts and record your audio.</p>
        
        <!-- Filters and Search -->
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- Language Selection -->
                <div class="flex-1">
                    <label for="language-filter" class="block text-sm font-medium text-gray-700 mb-1">
                        Language
                    </label>
                    <select id="language-filter" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">All Languages</option>
                        <!-- Languages will be populated via JavaScript -->
                    </select>
                </div>
                
                <!-- Search Input -->
                <div class="flex-2">
                    <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">
                        Search Scripts
                    </label>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search by title, content, or category..." 
                               class="block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-600 mb-2"></i>
            <p class="text-gray-600">Loading scripts...</p>
        </div>
        
        <!-- Scripts Container -->
        <div id="scripts-container" class="grid gap-4 mb-6" style="display: none;">
            <!-- Scripts will be populated via JavaScript -->
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="text-center py-8" style="display: none;">
            <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No scripts found</h3>
            <p class="text-gray-500">Try adjusting your search criteria or language filter.</p>
        </div>
        
        <!-- Load More Button -->
        <div id="load-more-container" class="text-center" style="display: none;">
            <button id="load-more-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-chevron-down mr-2"></i>
                Load More Scripts
            </button>
        </div>
        
        <div class="border-t pt-4 text-sm text-gray-500">
            <p><i class="fas fa-info-circle mr-2"></i>Scripts are created by administrators. Select a script above to provide your recording.</p>
        </div>
    </div>
</div>

<script>
// Global state
let currentPage = 1;
let currentLanguage = '';
let currentSearch = '';
let isLoading = false;
let hasNextPage = true;
let searchTimeout = null;

// Global recording state per script
let mediaRecorders = {};
let audioChunks = {};
let recordedBlobs = {};
let speechRecognitions = {}; // Store speech recognition instances per script

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load languages dropdown
    loadLanguages();
    
    // Load initial scripts
    loadScripts(true);
    
    // Set up event listeners
    setupEventListeners();
    
    // Initialize URL params
    initializeFromURLParams();
});

// Load available languages
function loadLanguages() {
    fetch('/api/languages')
        .then(response => response.json())
        .then(languages => {
            const select = document.getElementById('language-filter');
            select.innerHTML = '<option value="">All Languages</option>';
            
            languages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.code;
                option.textContent = `${lang.name} (${lang.native_name || lang.code})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading languages:', error);
        });
}

// Set up event listeners
function setupEventListeners() {
    // Language filter change
    document.getElementById('language-filter').addEventListener('change', function() {
        currentLanguage = this.value;
        currentPage = 1;
        hasNextPage = true;
        updateURLParams();
        loadScripts(true);
    });
    
    // Search input with debounce
    document.getElementById('search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = this.value.trim();
            currentPage = 1;
            hasNextPage = true;
            updateURLParams();
            loadScripts(true);
        }, 500); // 500ms debounce
    });
    
    // Load more button
    document.getElementById('load-more-btn').addEventListener('click', function() {
        if (!isLoading && hasNextPage) {
            currentPage++;
            loadScripts(false);
        }
    });
}

// Initialize from URL parameters
function initializeFromURLParams() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.has('language')) {
        currentLanguage = urlParams.get('language');
        document.getElementById('language-filter').value = currentLanguage;
    }
    
    if (urlParams.has('q')) {
        currentSearch = urlParams.get('q');
        document.getElementById('search-input').value = currentSearch;
    }
    
    if (urlParams.has('page')) {
        currentPage = parseInt(urlParams.get('page')) || 1;
    }
}

// Update URL parameters
function updateURLParams() {
    const params = new URLSearchParams();
    
    if (currentLanguage) {
        params.set('language', currentLanguage);
    }
    
    if (currentSearch) {
        params.set('q', currentSearch);
    }
    
    if (currentPage > 1) {
        params.set('page', currentPage);
    }
    
    const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.replaceState({}, '', newURL);
}

// Load scripts from API
function loadScripts(reset = false) {
    if (isLoading) return;
    
    isLoading = true;
    
    // Show loading state
    if (reset) {
        document.getElementById('loading-state').style.display = 'block';
        document.getElementById('scripts-container').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('load-more-container').style.display = 'none';
    } else {
        // Show loading on button
        const loadMoreBtn = document.getElementById('load-more-btn');
        loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
        loadMoreBtn.disabled = true;
    }
    
    // Build API URL
    const params = new URLSearchParams({
        page: currentPage,
        page_size: 20
    });
    
    if (currentLanguage) {
        params.set('language', currentLanguage);
    }
    
    if (currentSearch) {
        params.set('q', currentSearch);
    }
    
    fetch(`/api/scripts?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            isLoading = false;
            hasNextPage = data.has_next;
            
            // Hide loading state
            document.getElementById('loading-state').style.display = 'none';
            
            if (reset) {
                // Clear existing scripts
                document.getElementById('scripts-container').innerHTML = '';
            }
            
            if (data.items.length === 0 && reset) {
                // Show empty state
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('scripts-container').style.display = 'none';
                document.getElementById('load-more-container').style.display = 'none';
            } else {
                // Show scripts
                document.getElementById('scripts-container').style.display = 'block';
                document.getElementById('empty-state').style.display = 'none';
                
                // Render scripts
                data.items.forEach(script => {
                    renderScript(script);
                });
                
                // Show/hide load more button
                if (hasNextPage) {
                    document.getElementById('load-more-container').style.display = 'block';
                    const loadMoreBtn = document.getElementById('load-more-btn');
                    loadMoreBtn.innerHTML = '<i class="fas fa-chevron-down mr-2"></i>Load More Scripts';
                    loadMoreBtn.disabled = false;
                } else {
                    document.getElementById('load-more-container').style.display = 'none';
                }
            }
            
            updateURLParams();
        })
        .catch(error => {
            console.error('Error loading scripts:', error);
            isLoading = false;
            
            // Hide loading state and show error
            document.getElementById('loading-state').style.display = 'none';
            
            // Reset load more button if it was loading
            if (!reset) {
                const loadMoreBtn = document.getElementById('load-more-btn');
                loadMoreBtn.innerHTML = '<i class="fas fa-chevron-down mr-2"></i>Load More Scripts';
                loadMoreBtn.disabled = false;
            }
        });
}

// Render a script card
function renderScript(script) {
    const container = document.getElementById('scripts-container');
    
    const scriptElement = document.createElement('div');
    scriptElement.className = 'border border-gray-200 rounded-lg';
    scriptElement.id = `script-${script.id}`;
    
    scriptElement.innerHTML = `
        <div class="p-4">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900">${escapeHtml(script.title || 'Untitled Script')}</h3>
                    <p class="text-sm text-gray-600 mt-1">${escapeHtml(script.content)}</p>
                    <div class="flex items-center space-x-4 text-xs text-gray-500 mt-2">
                        <span>${escapeHtml(script.category || 'General')}</span>
                        <span>${escapeHtml(script.difficulty || 'Medium')}</span>
                        ${script.target_duration ? `<span>${Math.round(script.target_duration / 60 * 10) / 10}min</span>` : ''}
                    </div>
                </div>
                <div class="flex items-center space-x-2 ml-4">
                    <button 
                        onclick="toggleRecording(${script.id})" 
                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"
                        id="record-btn-${script.id}">
                        <i class="fas fa-microphone mr-1"></i>
                        Record
                    </button>
                    <button 
                        onclick="toggleSubmissions(${script.id})" 
                        class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                        id="submissions-btn-${script.id}">
                        <i class="fas fa-list mr-1"></i>
                        {% if session.user_role == 'admin' %}All Recordings{% else %}My Recordings{% endif %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Recording Interface (Hidden by default) -->
        <div id="recording-interface-${script.id}" class="border-t bg-gray-50 p-4" style="display: none;">
            <!-- Content will be loaded dynamically -->
        </div>

        <!-- User Submissions List (Hidden by default) -->
        <div id="submissions-list-${script.id}" class="border-t bg-gray-50 p-4" style="display: none;">
            <h4 class="font-semibold text-gray-900 mb-3">{% if session.user_role == 'admin' %}All Recordings for this Script{% else %}My Recordings for this Script{% endif %}</h4>
            <div class="submissions-content-${script.id}">
                <div class="text-center text-gray-500 py-4">
                    Loading recordings...
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(scriptElement);
}

// Toggle recording interface
function toggleRecording(scriptId) {
    // Close all other interfaces first
    document.querySelectorAll('[id^="recording-interface-"], [id^="submissions-list-"]').forEach(el => {
        if (el.id !== `recording-interface-${scriptId}`) {
            el.style.display = 'none';
        }
    });
    
    // Stop any active recordings
    Object.keys(mediaRecorders).forEach(id => {
        if (id != scriptId && mediaRecorders[id] && mediaRecorders[id].state !== 'inactive') {
            mediaRecorders[id].stop();
        }
    });
    
    const recordingInterface = document.getElementById(`recording-interface-${scriptId}`);
    
    // Toggle current recording interface - check both 'none' and empty string
    const isHidden = recordingInterface.style.display === 'none' || recordingInterface.style.display === '';
    if (isHidden) {
        recordingInterface.style.display = 'block';
        loadRecordingInterface(scriptId);
    } else {
        recordingInterface.style.display = 'none';
        // Stop recording if active
        if (mediaRecorders[scriptId] && mediaRecorders[scriptId].state !== 'inactive') {
            mediaRecorders[scriptId].stop();
        }
    }
}

// Load recording interface content
function loadRecordingInterface(scriptId) {
    const container = document.getElementById(`recording-interface-${scriptId}`);
    
    // Show loading
    container.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin text-blue-600 mb-2"></i>
            <p class="text-gray-600">Loading recording interface...</p>
        </div>
    `;
    
    // Fetch full script details
    fetch(`/api/scripts/${scriptId}/details`)
        .then(response => response.json())
        .then(script => {
            container.innerHTML = `
                <h4 class="font-semibold text-gray-900 mb-3">Record: ${escapeHtml(script.title)}</h4>
                
                <!-- Full Script Content -->
                <div class="bg-white p-4 rounded-lg mb-4">
                    <h5 class="font-medium text-gray-800 mb-2">Recording Prompt:</h5>
                    <p class="text-gray-700 leading-relaxed">${escapeHtml(script.content)}</p>
                </div>

                <form id="recording-form-${scriptId}" class="recording-form" data-script-id="${scriptId}">
                    <!-- Audio Recording -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Audio Recording (Required)
                        </label>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                            <div class="text-center">
                                <div class="recording-controls-${scriptId} space-y-2">
                                    <div>
                                        <button 
                                            type="button" 
                                            onclick="startRecording(${scriptId})" 
                                            class="start-recording inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
                                            <i class="fas fa-microphone mr-2"></i>
                                            Start Recording
                                        </button>
                                        <button 
                                            type="button" 
                                            onclick="stopRecording(${scriptId})" 
                                            class="stop-recording inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700 ml-2" 
                                            style="display: none;">
                                            <i class="fas fa-stop mr-2"></i>
                                            Stop Recording
                                        </button>
                                    </div>
                                    
                                    <div class="recording-status-${scriptId} text-sm text-gray-500"></div>
                                    
                                    <audio class="audio-playback-${scriptId}" controls style="display: none;" class="mt-4"></audio>
                                </div>
                            </div>
                        </div>

                        <!-- Real-time Transcript Display -->
                        <div id="transcript-container-${scriptId}" class="mt-4 bg-blue-50 border-2 border-blue-200 rounded-lg p-4" style="display: none;">
                            <div class="flex items-start space-x-2 mb-2">
                                <i class="fas fa-microphone-alt text-blue-600 mt-1"></i>
                                <div class="flex-1">
                                    <h5 class="font-medium text-blue-900 mb-1">Live Transcript</h5>
                                    <div id="transcript-${scriptId}" class="text-gray-700 min-h-[60px] whitespace-pre-wrap leading-relaxed">
                                        Listening...
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-blue-600 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                <span id="transcript-status-${scriptId}">Speech recognition active</span>
                            </div>
                        </div>

                        <input type="file" class="audio-file-input" accept="audio/*" style="display: none;">
                    </div>

                    <!-- Optional Notes -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Additional Notes (Optional)
                        </label>
                        <textarea 
                            name="text_content" 
                            rows="2" 
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            placeholder="Add any notes or comments about your recording (optional)..."></textarea>
                    </div>

                    <!-- Submit and Cancel Buttons -->
                    <div class="flex items-center justify-between">
                        <button 
                            type="submit" 
                            class="submit-recording inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Submit Recording
                        </button>
                        
                        <button 
                            type="button" 
                            onclick="cancelRecording(${scriptId})"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Cancel
                        </button>
                    </div>
                </form>
            `;
        })
        .catch(error => {
            console.error('Error loading script details:', error);
            container.innerHTML = `
                <div class="text-center py-4 text-red-600">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <p>Error loading recording interface. Please try again.</p>
                </div>
            `;
        });
}

// Toggle submissions list
function toggleSubmissions(scriptId) {
    // Close all other interfaces first
    document.querySelectorAll('[id^="recording-interface-"], [id^="submissions-list-"]').forEach(el => {
        if (el.id !== `submissions-list-${scriptId}`) {
            el.style.display = 'none';
        }
    });
    
    // Stop any active recordings
    Object.keys(mediaRecorders).forEach(id => {
        if (mediaRecorders[id] && mediaRecorders[id].state !== 'inactive') {
            mediaRecorders[id].stop();
        }
    });
    
    const submissionsList = document.getElementById(`submissions-list-${scriptId}`);
    
    // Toggle current submissions list - check both 'none' and empty string
    const isHidden = submissionsList.style.display === 'none' || submissionsList.style.display === '';
    if (isHidden) {
        submissionsList.style.display = 'block';
        loadSubmissions(scriptId);
    } else {
        submissionsList.style.display = 'none';
    }
}

// Load user submissions for a script
function loadSubmissions(scriptId) {
    const container = document.querySelector(`.submissions-content-${scriptId}`);
    const isAdmin = '{{ session.user_role }}' === 'admin';
    
    fetch(`/api/user-submissions/${scriptId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.submissions && data.submissions.length > 0) {
                container.innerHTML = data.submissions.map(submission => {
                    const statusColor = submission.status === 'approved' ? 'green' : 
                                       submission.status === 'rejected' ? 'red' : 'yellow';
                    const statusIcon = submission.status === 'approved' ? 'check-circle' : 
                                      submission.status === 'rejected' ? 'times-circle' : 'clock';
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 mb-3" data-submission-id="${submission.id}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center flex-wrap gap-2 mb-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                            <i class="fas fa-${statusIcon} mr-1"></i>
                                            ${submission.status.charAt(0).toUpperCase() + submission.status.slice(1)}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            ${new Date(submission.created_at).toLocaleDateString()}
                                        </span>
                                        ${submission.submitter ? `
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${submission.submitter_type === 'field' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                                                <i class="fas fa-${submission.submitter_type === 'field' ? 'map-marker-alt' : 'user'} mr-1"></i>
                                                ${escapeHtml(submission.submitter)}
                                            </span>
                                        ` : ''}
                                    </div>
                                    
                                    ${submission.audio_url ? `
                                        <audio controls preload="none" class="w-full mb-2" data-audio-player>
                                            <source src="${submission.audio_url}">
                                            Your browser does not support the audio element.
                                        </audio>
                                    ` : '<p class="text-sm text-gray-400 mb-2">No audio file</p>'}
                                    
                                    ${submission.text_content ? `
                                        <p class="text-sm text-gray-600 mb-2">${escapeHtml(submission.text_content)}</p>
                                    ` : ''}
                                </div>
                                
                                ${isAdmin ? `
                                    <button onclick="deleteRecordingFromList(${submission.id}, ${scriptId})" 
                                            class="text-red-600 hover:text-red-900 ml-2 px-2 py-1 rounded hover:bg-red-50"
                                            data-testid="button-delete-${submission.id}"
                                            title="Delete recording">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners for audio players to pause others when one plays
                container.querySelectorAll('audio[data-audio-player]').forEach(audio => {
                    audio.addEventListener('play', () => {
                        container.querySelectorAll('audio[data-audio-player]').forEach(otherAudio => {
                            if (otherAudio !== audio) {
                                otherAudio.pause();
                            }
                        });
                    });
                });
            } else {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-microphone-slash text-2xl mb-2"></i>
                        <p>No recordings yet for this script.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading submissions:', error);
            container.innerHTML = `
                <div class="text-center text-red-500 py-4">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <p>Error loading recordings. Please try again.</p>
                </div>
            `;
        });
}

// Cancel recording
function cancelRecording(scriptId) {
    // Stop recording if active
    if (mediaRecorders[scriptId] && mediaRecorders[scriptId].state !== 'inactive') {
        mediaRecorders[scriptId].stop();
    }
    
    // Stop speech recognition if active
    if (speechRecognitions[scriptId]) {
        speechRecognitions[scriptId].stop();
        delete speechRecognitions[scriptId];
    }
    
    // Hide recording interface and transcript
    document.getElementById(`recording-interface-${scriptId}`).style.display = 'none';
    const transcriptContainer = document.getElementById(`transcript-container-${scriptId}`);
    if (transcriptContainer) {
        transcriptContainer.style.display = 'none';
    }
    
    // Clean up
    delete audioChunks[scriptId];
    delete recordedBlobs[scriptId];
}

// Start recording
function startRecording(scriptId) {
    const statusElement = document.querySelector(`.recording-status-${scriptId}`);
    const startBtn = document.querySelector(`#recording-interface-${scriptId} .start-recording`);
    const stopBtn = document.querySelector(`#recording-interface-${scriptId} .stop-recording`);
    const audioPlayback = document.querySelector(`.audio-playback-${scriptId}`);
    const transcriptContainer = document.getElementById(`transcript-container-${scriptId}`);
    const transcriptElement = document.getElementById(`transcript-${scriptId}`);
    const transcriptStatus = document.getElementById(`transcript-status-${scriptId}`);
    
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorders[scriptId] = new MediaRecorder(stream);
            audioChunks[scriptId] = [];
            
            mediaRecorders[scriptId].ondataavailable = function(event) {
                audioChunks[scriptId].push(event.data);
            };
            
            mediaRecorders[scriptId].onstop = function() {
                const audioBlob = new Blob(audioChunks[scriptId], { type: 'audio/webm' });
                recordedBlobs[scriptId] = audioBlob;
                
                const audioURL = URL.createObjectURL(audioBlob);
                audioPlayback.src = audioURL;
                audioPlayback.style.display = 'block';
                
                statusElement.textContent = 'Recording complete. You can play it back above.';
                
                // Stop all tracks to free up microphone
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorders[scriptId].start();
            
            // Initialize Web Speech API for real-time transcription
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognitions[scriptId] = new SpeechRecognition();
                
                speechRecognitions[scriptId].continuous = true;
                speechRecognitions[scriptId].interimResults = true;
                speechRecognitions[scriptId].lang = 'en-US'; // Default language
                
                let finalTranscript = '';
                
                speechRecognitions[scriptId].onresult = function(event) {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Display transcript (final in black, interim in gray)
                    transcriptElement.innerHTML = finalTranscript + 
                        '<span style="color: #9CA3AF;">' + interimTranscript + '</span>';
                };
                
                speechRecognitions[scriptId].onerror = function(event) {
                    console.log('Speech recognition error:', event.error);
                    if (event.error === 'no-speech') {
                        transcriptStatus.textContent = 'No speech detected. Keep speaking...';
                    } else {
                        transcriptStatus.textContent = 'Transcription paused';
                    }
                };
                
                speechRecognitions[scriptId].onend = function() {
                    // Auto-restart if recording is still active
                    if (mediaRecorders[scriptId] && mediaRecorders[scriptId].state === 'recording') {
                        speechRecognitions[scriptId].start();
                    }
                };
                
                try {
                    speechRecognitions[scriptId].start();
                    transcriptContainer.style.display = 'block';
                    transcriptElement.textContent = 'Listening...';
                    transcriptStatus.textContent = 'Speech recognition active';
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                }
            } else {
                // Speech recognition not supported
                console.log('Speech recognition not supported in this browser');
            }
            
            // Update UI
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-flex';
            statusElement.textContent = 'Recording... Click "Stop Recording" when finished.';
            audioPlayback.style.display = 'none';
        })
        .catch(error => {
            console.error('Error accessing microphone:', error);
            statusElement.textContent = 'Error: Could not access microphone. Please check permissions.';
        });
}

// Stop recording
function stopRecording(scriptId) {
    if (mediaRecorders[scriptId] && mediaRecorders[scriptId].state !== 'inactive') {
        mediaRecorders[scriptId].stop();
        
        // Stop speech recognition
        if (speechRecognitions[scriptId]) {
            speechRecognitions[scriptId].stop();
            const transcriptStatus = document.getElementById(`transcript-status-${scriptId}`);
            if (transcriptStatus) {
                transcriptStatus.textContent = 'Transcription complete';
            }
        }
        
        // Update UI immediately
        const startBtn = document.querySelector(`#recording-interface-${scriptId} .start-recording`);
        const stopBtn = document.querySelector(`#recording-interface-${scriptId} .stop-recording`);
        
        startBtn.style.display = 'inline-flex';
        stopBtn.style.display = 'none';
    }
}

// Delete submission
function deleteSubmission(submissionId, scriptId) {
    if (!confirm('Are you sure you want to delete this recording?')) {
        return;
    }
    
    fetch(`/api/submissions/${submissionId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload submissions list
            loadSubmissions(scriptId);
        } else {
            alert('Error deleting recording: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting recording. Please try again.');
    });
}

// Delete recording from list with optimistic UI update
function deleteRecordingFromList(submissionId, scriptId) {
    if (!confirm('Are you sure you want to delete this recording? This action cannot be undone.')) {
        return;
    }
    
    const recordingElement = document.querySelector(`[data-submission-id="${submissionId}"]`);
    const deleteButton = recordingElement.querySelector('button[data-testid^="button-delete-"]');
    
    // Pause audio if playing
    const audioPlayer = recordingElement.querySelector('audio');
    if (audioPlayer) {
        audioPlayer.pause();
    }
    
    // Show loading state
    if (deleteButton) {
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    fetch(`/api/submissions/${submissionId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Optimistically remove from DOM
            recordingElement.remove();
            
            // Check if list is now empty
            const container = document.querySelector(`.submissions-content-${scriptId}`);
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-microphone-slash text-2xl mb-2"></i>
                        <p>No recordings yet for this script.</p>
                    </div>
                `;
            }
        } else {
            alert('Error deleting recording: ' + (data.error || 'Unknown error'));
            // Re-enable button on error
            if (deleteButton) {
                deleteButton.disabled = false;
                deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting recording. Please try again.');
        // Re-enable button on error
        if (deleteButton) {
            deleteButton.disabled = false;
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
        }
    });
}

// Utility function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Form submission handling
document.addEventListener('submit', function(e) {
    if (e.target.classList.contains('recording-form')) {
        e.preventDefault();
        
        const form = e.target;
        const scriptId = form.dataset.scriptId;
        const submitBtn = form.querySelector('.submit-recording');
        const originalText = submitBtn.innerHTML;
        
        // Check if recording exists
        if (!recordedBlobs[scriptId]) {
            alert('Please record audio before submitting.');
            return;
        }
        
        // Update button state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        submitBtn.disabled = true;
        
        // Prepare form data
        const formData = new FormData();
        formData.append('script_id', scriptId);
        formData.append('audio_file', recordedBlobs[scriptId], 'recording.webm');
        
        const textContent = form.querySelector('[name="text_content"]').value;
        if (textContent) {
            formData.append('text_content', textContent);
        }
        
        // Submit the recording
        fetch('/submit_recording', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Recording submitted successfully!');
                // Hide recording interface and reset form
                cancelRecording(scriptId);
                // Refresh submissions if they're shown
                const submissionsList = document.getElementById(`submissions-list-${scriptId}`);
                if (submissionsList.style.display === 'block') {
                    loadSubmissions(scriptId);
                }
            } else {
                alert('Error submitting recording: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting recording. Please try again.');
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }
});
</script>
{% endblock %}